<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNUE Board Hub - Cache Clear</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 20px;
        }
        .cache-item {
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .cache-item h3 {
            margin: 0 0 10px 0;
            color: #374151;
        }
        .cache-item p {
            margin: 0 0 10px 0;
            color: #6b7280;
            font-size: 14px;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #b91c1c;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .success {
            color: #059669;
            font-weight: 500;
        }
        .error {
            color: #dc2626;
            font-weight: 500;
        }
        .clear-all {
            background: #7c3aed;
            font-size: 16px;
            padding: 12px 24px;
            margin: 20px 0;
        }
        .clear-all:hover {
            background: #6d28d9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¹ ìºì‹œ ì´ˆê¸°í™” ë„êµ¬</h1>
        <p>RSS ë‚ ì§œ íŒŒì‹± ìˆ˜ì •ìœ¼ë¡œ ì¸í•´ ê¸°ì¡´ ìºì‹œë¥¼ ì´ˆê¸°í™”í•´ì•¼ í•©ë‹ˆë‹¤.</p>
        
        <div class="cache-item">
            <h3>ğŸ“± ë¸Œë¼ìš°ì € ìºì‹œ (localStorage)</h3>
            <p>ì„ íƒëœ ë¶€ì„œ, ë¶ë§ˆí¬, ì„¤ì • ë“±ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
            <button onclick="clearLocalStorage()">ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™”</button>
            <span id="localStorage-status"></span>
        </div>
        
        <div class="cache-item">
            <h3>ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ RSS ìºì‹œ</h3>
            <p>ì„œë²„ì— ì €ì¥ëœ RSS ê²Œì‹œë¬¼ ìºì‹œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
            <button onclick="clearDatabaseCache()">ë°ì´í„°ë² ì´ìŠ¤ ìºì‹œ ì´ˆê¸°í™”</button>
            <span id="database-status"></span>
        </div>
        
        <div class="cache-item">
            <h3>ğŸ”„ RSS ìƒˆë¡œê³ ì¹¨</h3>
            <p>ëª¨ë“  ë¶€ì„œì˜ RSSë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ì˜¬ë°”ë¥¸ ë‚ ì§œë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p>
            <button onclick="refreshAllRss()">ì „ì²´ RSS ìƒˆë¡œê³ ì¹¨</button>
            <span id="refresh-status"></span>
        </div>
        
        <button class="clear-all" onclick="clearAllCaches()">ğŸš€ ëª¨ë“  ìºì‹œ ì´ˆê¸°í™” + RSS ìƒˆë¡œê³ ì¹¨</button>
        <div id="all-status"></div>
        
        <hr style="margin: 30px 0;">
        <p><strong>ì´ˆê¸°í™” í›„:</strong></p>
        <ul>
            <li>ì•±ì„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”</li>
            <li>ê²Œì‹œë¬¼ì´ ì˜¬ë°”ë¥¸ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”</li>
            <li>ê¸°ë³¸ ë¶€ì„œë“¤ì´ ìë™ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤</li>
        </ul>
        
        <a href="/" style="display: inline-block; margin-top: 20px; color: #2563eb;">â† ë©”ì¸ ì•±ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <script>
        const API_BASE = window.location.origin.includes('localhost:5174') ? 
                        'http://localhost:8787' : 
                        window.location.origin;

        function setStatus(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = isSuccess ? 'success' : 'error';
        }

        function clearLocalStorage() {
            try {
                // ìºì‹œ ê´€ë ¨ í‚¤ë“¤ ì‚­ì œ
                const keysToDelete = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.startsWith('knue-') || 
                        key.startsWith('rss-') || 
                        key.startsWith('departments') ||
                        key.includes('cache') ||
                        key.includes('feed')
                    )) {
                        keysToDelete.push(key);
                    }
                }
                
                keysToDelete.forEach(key => localStorage.removeItem(key));
                
                setStatus('localStorage-status', `âœ… ${keysToDelete.length}ê°œ í•­ëª© ì‚­ì œë¨`, true);
            } catch (error) {
                setStatus('localStorage-status', `âŒ ì˜¤ë¥˜: ${error.message}`, false);
            }
        }

        async function clearDatabaseCache() {
            try {
                const response = await fetch(`${API_BASE}/api/cache/clear`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setStatus('database-status', `âœ… ${result.data.rss_cache_cleared}ê°œ RSS ìºì‹œ ì‚­ì œë¨`, true);
                } else {
                    setStatus('database-status', `âŒ ì˜¤ë¥˜: ${result.error}`, false);
                }
            } catch (error) {
                setStatus('database-status', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, false);
            }
        }

        async function refreshAllRss() {
            try {
                setStatus('refresh-status', 'ğŸ”„ RSS ìƒˆë¡œê³ ì¹¨ ì¤‘...', true);
                
                const response = await fetch(`${API_BASE}/api/rss/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) // ëª¨ë“  ë¶€ì„œ ìƒˆë¡œê³ ì¹¨
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const totalNew = result.data.reduce((sum, dept) => sum + (dept.newItems || 0), 0);
                    const totalItems = result.data.reduce((sum, dept) => sum + (dept.totalItems || 0), 0);
                    setStatus('refresh-status', `âœ… ìƒˆ ì•„ì´í…œ ${totalNew}ê°œ, ì´ ${totalItems}ê°œ ì²˜ë¦¬ë¨`, true);
                } else {
                    setStatus('refresh-status', `âŒ ì˜¤ë¥˜: ${result.error}`, false);
                }
            } catch (error) {
                setStatus('refresh-status', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, false);
            }
        }

        async function clearAllCaches() {
            setStatus('all-status', 'ğŸ”„ ëª¨ë“  ìºì‹œ ì´ˆê¸°í™” ì¤‘...', true);
            
            try {
                // 1. ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™”
                clearLocalStorage();
                
                // 2. ë°ì´í„°ë² ì´ìŠ¤ ìºì‹œ ì´ˆê¸°í™”
                await clearDatabaseCache();
                
                // 3. RSS ìƒˆë¡œê³ ì¹¨
                await refreshAllRss();
                
                setStatus('all-status', 'ğŸ‰ ëª¨ë“  ìºì‹œê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', true);
                
                // 5ì´ˆ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
                
            } catch (error) {
                setStatus('all-status', `âŒ ì˜¤ë¥˜: ${error.message}`, false);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ìºì‹œ ìƒíƒœ í™•ì¸
        window.addEventListener('load', () => {
            const localStorageKeys = Object.keys(localStorage).filter(key => 
                key.startsWith('knue-') || key.startsWith('rss-') || key.includes('cache')
            );
            
            if (localStorageKeys.length > 0) {
                setStatus('localStorage-status', `í˜„ì¬ ${localStorageKeys.length}ê°œ í•­ëª© ì €ì¥ë¨`, false);
            }
        });
    </script>
</body>
</html>